<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Ekansh vs Kaju Katli & Kopra Pathi Advanced</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
<style>
  html, body { margin:0; padding:0; background:#000; height:100%; overflow:hidden; }
  button { position:absolute; bottom:20px; font-size:18px; padding:10px 20px; display:none; }
</style>
</head>
<body>

<button id="retryBtn">RETRY</button>
<button id="nextBtn">NEXT</button>

<script>
const config = {
  type: Phaser.AUTO,
  width: window.innerWidth,
  height: window.innerHeight,
  backgroundColor: "#111",
  physics: { default: 'arcade', arcade: { debug: false } },
  scene: { preload, create, update }
};
const game = new Phaser.Game(config);

let player, goodBalls, badBalls;
let scoreText, score = 0, level = 1;
let gameOver = false, powers = {};
let ballSpeed = 160, spawnRate = 1000;
let powerActive = null;
let highScore = localStorage.getItem('highScore') || 0;

function preload() {
  this.load.image('player', 'ekansh.png');
  this.load.image('good', 'kopra Pathi.png');
  this.load.image('danger', 'kaju Katli.png');
}

function create() {
  const w = this.scale.width;
  const h = this.scale.height;
  gameOver = false;
  score = 0;
  ballSpeed = 160;
  spawnRate = 1000;
  powerActive = null;

  // Player
  player = this.physics.add.sprite(w/2, h-100, 'player').setScale(0.18).setCollideWorldBounds(true);
  player.nameText = this.add.text(player.x, player.y-50, 'EKANSH', { fontSize:'18px', fill:'#00ff00' }).setOrigin(0.5);

  // Touch movement
  this.input.on('pointermove', pointer => { if(!gameOver) player.x = pointer.x; });

  // Groups
  goodBalls = this.physics.add.group();
  badBalls = this.physics.add.group();

  // Score
  scoreText = this.add.text(20,20,'Score: 0',{ fontSize:'24px', fill:'#fff' });

  // Spawn balls
  this.time.addEvent({ delay: spawnRate, loop: true, callback: ()=>spawnBall(this) });

  // Collisions
  this.physics.add.overlap(player, goodBalls, collectGood, null, this);
  this.physics.add.overlap(player, badBalls, hitBad, null, this);

  // Powers manager
  powers = { magnet:false, invisible:false, speed:false, double:false };
}

function spawnBall(scene) {
  if(gameOver) return;
  const w = scene.scale.width;
  const isGood = Phaser.Math.Between(0,1);
  const x = Phaser.Math.Between(40, w-40);
  let ball, name;
  if(isGood){
    ball = goodBalls.create(x, -20, 'good').setScale(0.18);
    name = scene.add.text(ball.x, ball.y-25, 'KOPRA PATHI', {fontSize:'16px', fill:'#0ff'}).setOrigin(0.5);
  } else {
    ball = badBalls.create(x, -20, 'danger').setScale(0.18);
    name = scene.add.text(ball.x, ball.y-25, 'KAJU KATLI', {fontSize:'16px', fill:'#ff5555'}).setOrigin(0.5);
  }
  ball.body.setVelocityY(ballSpeed + Phaser.Math.Between(0,50));
  ball.nameText = name;
}

function update() {
  if(gameOver) return;

  // Move texts with balls
  goodBalls.children.iterate(b=>{ if(b && b.nameText){ b.nameText.setPosition(b.x,b.y-25); if(b.y>this.scale.height+40){ b.nameText.destroy(); b.destroy(); } } });
  badBalls.children.iterate(b=>{ if(b && b.nameText){ b.nameText.setPosition(b.x,b.y-25); if(b.y>this.scale.height+40){ b.nameText.destroy(); b.destroy(); } } });

  // Keep player name above
  if(player && player.nameText) player.nameText.setPosition(player.x, player.y-50);

  // Apply magnet power
  if(powers.magnet){
    goodBalls.children.iterate(b=>{ if(b) { b.x = Phaser.Math.Linear(b.x, player.x, 0.05); } });
  }

  // Level up
  if(score >= level*100 && level<10){
    level++;
    ballSpeed += 20;
    spawnRate = Math.max(400, spawnRate-50);
  }

  // Win condition
  if(level > 10){
    endGameMsg('YOU WON');
  }
}

// Collect good ball
function collectGood(p,ball){
  if(ball.nameText) ball.nameText.destroy();
  ball.destroy();
  score += powers.double? 20 : 10;
  scoreText.setText('Score: '+score);
}

// Hit bad ball
function hitBad(p,ball){
  if(powerActive==='invisible') return; // Ignore collision
  if(ball.nameText) ball.nameText.destroy();
  ball.destroy();
  endGameMsg('YOU LOSS');
}

// End game message & buttons
function endGameMsg(msg){
  gameOver = true;
  goodBalls.setVelocityY(0);
  badBalls.setVelocityY(0);
  goodBalls.children.iterate(b=>{ if(b.nameText) b.nameText.destroy(); });
  badBalls.children.iterate(b=>{ if(b.nameText) b.nameText.destroy(); });

  scoreText.setText(score+' pts | Level '+level);
  if(score>highScore){ highScore=score; localStorage.setItem('highScore',highScore); }

  const text = game.scene.scenes[0].add.text(game.config.width/2, game.config.height/2, msg+'\nScore: '+score+'\nHighScore: '+highScore,
    {fontSize:'28px', fill:'#fff', align:'center'}).setOrigin(0.5);

  // Show buttons
  const retryBtn = document.getElementById('retryBtn');
  const nextBtn = document.getElementById('nextBtn');
  retryBtn.style.display='block'; nextBtn.style.display=(msg==='YOU WON')?'block':'none';

  retryBtn.onclick = ()=>{ retryBtn.style.display='none'; nextBtn.style.display='none'; game.scene.scenes[0].scene.restart(); };
  nextBtn.onclick = ()=>{ retryBtn.style.display='none'; nextBtn.style.display='none'; level=1; score=0; ballSpeed=160; spawnRate=1000; game.scene.scenes[0].scene.restart(); };
}
</script>
</body>
</html>
